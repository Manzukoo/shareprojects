const express = require("express");
const morgan = require("morgan");
const path = require("path");
const flash = require("connect-flash");
const session = require("express-session");
const MySQLStore = require("express-mysql-session");
const passport = require("passport");
const helper = require("./lib/helpers")
const { database } = require("./keys");






// /*
// .####.##....##.####..######..####....###....##.......####.########....###.....######..####..#######..##....##.########..######.
// ..##..###...##..##..##....##..##....##.##...##........##.......##....##.##...##....##..##..##.....##.###...##.##.......##....##
// ..##..####..##..##..##........##...##...##..##........##......##....##...##..##........##..##.....##.####..##.##.......##......
// ..##..##.##.##..##..##........##..##.....##.##........##.....##....##.....##.##........##..##.....##.##.##.##.######....######.
// ..##..##..####..##..##........##..#########.##........##....##.....#########.##........##..##.....##.##..####.##.............##
// ..##..##...###..##..##....##..##..##.....##.##........##...##......##.....##.##....##..##..##.....##.##...###.##.......##....##
// .####.##....##.####..######..####.##.....##.########.####.########.##.....##..######..####..#######..##....##.########..######.
// */
const app = express();
require("./lib/passport");






// /*
// ..######...#######..##....##.########.####..######...##.....##.########.....###.....######..####..#######..##....##.########..######.
// .##....##.##.....##.###...##.##........##..##....##..##.....##.##.....##...##.##...##....##..##..##.....##.###...##.##.......##....##
// .##.......##.....##.####..##.##........##..##........##.....##.##.....##..##...##..##........##..##.....##.####..##.##.......##......
// .##.......##.....##.##.##.##.######....##..##...####.##.....##.########..##.....##.##........##..##.....##.##.##.##.######....######.
// .##.......##.....##.##..####.##........##..##....##..##.....##.##...##...#########.##........##..##.....##.##..####.##.............##
// .##....##.##.....##.##...###.##........##..##....##..##.....##.##....##..##.....##.##....##..##..##.....##.##...###.##.......##....##
// ..######...#######..##....##.##.......####..######....#######..##.....##.##.....##..######..####..#######..##....##.########..######.
// */
app.set("port", process.env.PORT || 4000);
app.set("views", path.join(__dirname, "views"));

app.engine("html", require("ejs").renderFile);
app.set("view engine", ".ejs");






// /*
// .##.....##.####.########..########..##.......########.##......##....###....########..########..######.
// .###...###..##..##.....##.##.....##.##.......##.......##..##..##...##.##...##.....##.##.......##....##
// .####.####..##..##.....##.##.....##.##.......##.......##..##..##..##...##..##.....##.##.......##......
// .##.###.##..##..##.....##.##.....##.##.......######...##..##..##.##.....##.########..######....######.
// .##.....##..##..##.....##.##.....##.##.......##.......##..##..##.#########.##...##...##.............##
// .##.....##..##..##.....##.##.....##.##.......##.......##..##..##.##.....##.##....##..##.......##....##
// .##.....##.####.########..########..########.########..###..###..##.....##.##.....##.########..######.
// */
app.use(
  session({
    secret: "shareprojectssessions",
    resave: false,
    saveUninitialized: false,
    store: new MySQLStore(database),
  })
);

app.use(flash());
app.use(morgan("dev"));
app.use(express.urlencoded({ extended: false }));
app.use(express.json());
app.use(passport.initialize());
app.use(passport.session());






// /*
// .##.....##....###....########..####....###....########..##.......########..######......######...##........#######..########.....###....##.......########..######.
// .##.....##...##.##...##.....##..##....##.##...##.....##.##.......##.......##....##....##....##..##.......##.....##.##.....##...##.##...##.......##.......##....##
// .##.....##..##...##..##.....##..##...##...##..##.....##.##.......##.......##..........##........##.......##.....##.##.....##..##...##..##.......##.......##......
// .##.....##.##.....##.########...##..##.....##.########..##.......######....######.....##...####.##.......##.....##.########..##.....##.##.......######....######.
// ..##...##..#########.##...##....##..#########.##.....##.##.......##.............##....##....##..##.......##.....##.##.....##.#########.##.......##.............##
// ...##.##...##.....##.##....##...##..##.....##.##.....##.##.......##.......##....##....##....##..##.......##.....##.##.....##.##.....##.##.......##.......##....##
// ....###....##.....##.##.....##.####.##.....##.########..########.########..######......######...########..#######..########..##.....##.########.########..######.
// */
app.use((req, res, next) => {
  app.locals.success = req.flash("success");
  app.locals.err = req.flash("err");
  app.locals.loginSuccess = req.flash("loginSuccess");
  app.locals.logOut = req.flash("logOut");
  app.locals.user = req.user;
  app.locals.timeago = helper.timeago
  next();
});






// /*
// .########..##.....##.########....###.....######.
// .##.....##.##.....##....##......##.##...##....##
// .##.....##.##.....##....##.....##...##..##......
// .########..##.....##....##....##.....##..######.
// .##...##...##.....##....##....#########.......##
// .##....##..##.....##....##....##.....##.##....##
// .##.....##..#######.....##....##.....##..######.
// */
app.use(require("./routes"));
app.use(require("./routes/auth"));
app.use(require("./routes/profile"));
app.use("/proyectos", require("./routes/projects"));






// /*
// .########..##.....##.########..##.......####..######...#######.
// .##.....##.##.....##.##.....##.##........##..##....##.##.....##
// .##.....##.##.....##.##.....##.##........##..##.......##.....##
// .########..##.....##.########..##........##..##.......##.....##
// .##........##.....##.##.....##.##........##..##.......##.....##
// .##........##.....##.##.....##.##........##..##....##.##.....##
// .##.........#######..########..########.####..######...#######.
// */
app.use(express.static(path.join(__dirname, "public")));
console.log(path.join(__dirname, "public"))





// /*
// .####.##....##.####..######..####....###....########.....########.##...........######..########.########..##.....##.####.########...#######..########.
// ..##..###...##..##..##....##..##....##.##...##.....##....##.......##..........##....##.##.......##.....##.##.....##..##..##.....##.##.....##.##.....##
// ..##..####..##..##..##........##...##...##..##.....##....##.......##..........##.......##.......##.....##.##.....##..##..##.....##.##.....##.##.....##
// ..##..##.##.##..##..##........##..##.....##.########.....######...##...........######..######...########..##.....##..##..##.....##.##.....##.########.
// ..##..##..####..##..##........##..#########.##...##......##.......##................##.##.......##...##....##...##...##..##.....##.##.....##.##...##..
// ..##..##...###..##..##....##..##..##.....##.##....##.....##.......##..........##....##.##.......##....##....##.##....##..##.....##.##.....##.##....##.
// .####.##....##.####..######..####.##.....##.##.....##....########.########.....######..########.##.....##....###....####.########...#######..##.....##
// */
app.listen(app.get("port"), () => {
  console.log("Servidor en el Puerto " + app.get("port"));
});
