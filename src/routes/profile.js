const express = require("express");
const router = express.Router();

const passport = require("passport");
const { isLoggedIn, isNotLoggedIn } = require("../lib/auth");

const db = require("../database");






///*
//..######...########.########....########..########.########..########.####.##......
//.##....##..##..........##.......##.....##.##.......##.....##.##........##..##......
//.##........##..........##.......##.....##.##.......##.....##.##........##..##......
//.##...####.######......##.......########..######...########..######....##..##......
//.##....##..##..........##.......##........##.......##...##...##........##..##......
//.##....##..##..........##.......##........##.......##....##..##........##..##......
//..######...########....##.......##........########.##.....##.##.......####.########
//*/
router.get("/perfil", isLoggedIn, (req, res) => {
  res.render("profile/index.html");
});






///*
//..######...########.########....########..########.########..########.####.##.............##.########..########...#######..##....##.########..######..########..#######...######.
//.##....##..##..........##.......##.....##.##.......##.....##.##........##..##............##..##.....##.##.....##.##.....##..##..##..##.......##....##....##....##.....##.##....##
//.##........##..........##.......##.....##.##.......##.....##.##........##..##...........##...##.....##.##.....##.##.....##...####...##.......##..........##....##.....##.##......
//.##...####.######......##.......########..######...########..######....##..##..........##....########..########..##.....##....##....######...##..........##....##.....##..######.
//.##....##..##..........##.......##........##.......##...##...##........##..##.........##.....##........##...##...##.....##....##....##.......##..........##....##.....##.......##
//.##....##..##..........##.......##........##.......##....##..##........##..##........##......##........##....##..##.....##....##....##.......##....##....##....##.....##.##....##
//..######...########....##.......##........########.##.....##.##.......####.########.##.......##........##.....##..#######.....##....########..######.....##.....#######...######.
//*/
router.get("/perfil/proyectos", isLoggedIn, async (req, res) => {
  const projects = await db.query(
    "SELECT * FROM projects WHERE project_user_id = ?",
    [req.user.id]
  );
  console.log("DATOS SELECCIONADOS (PROJECTS)");
  res.render("profile/projects.html", { projects });
});






///*
//..######...########.########....########..########.########..########.####.##.............##.##.....##.####.########........##.########..########...#######..##....##.########..######..########..#######...######.
//.##....##..##..........##.......##.....##.##.......##.....##.##........##..##............##..##.....##..##..##.....##......##..##.....##.##.....##.##.....##..##..##..##.......##....##....##....##.....##.##....##
//.##........##..........##.......##.....##.##.......##.....##.##........##..##...........##...##.....##..##..##.....##.....##...##.....##.##.....##.##.....##...####...##.......##..........##....##.....##.##......
//.##...####.######......##.......########..######...########..######....##..##..........##....##.....##..##..##.....##....##....########..########..##.....##....##....######...##..........##....##.....##..######.
//.##....##..##..........##.......##........##.......##...##...##........##..##.........##.....##.....##..##..##.....##...##.....##........##...##...##.....##....##....##.......##..........##....##.....##.......##
//.##....##..##..........##.......##........##.......##....##..##........##..##........##......##.....##..##..##.....##..##......##........##....##..##.....##....##....##.......##....##....##....##.....##.##....##
//..######...########....##.......##........########.##.....##.##.......####.########.##........#######..####.########..##.......##........##.....##..#######.....##....########..######.....##.....#######...######.
//*/
router.get("/perfil/:id/proyectos", async (req, res) => {
  const { id } = req.params;
  const projects = await db.query(
    "SELECT * FROM projects WHERE project_user_id = ?",
    [id]
  );
  if (projects.length > 0) {
    console.log("DATOS SELECCIONADOS (PERFIL ID PROJECTS)");
    res.render("profile/projects.html", { projects });
  } else {
    req.flash("err", "El usuario con la ID " + id + " no existe.");
    res.redirect("/");
  }
});






///*
//..######...########.########....########..########.########..########.####.##.............##.##.....##.####.########........##.########..########...#######..##....##.########..######..########..#######........##.########..####.########.
//.##....##..##..........##.......##.....##.##.......##.....##.##........##..##............##..##.....##..##..##.....##......##..##.....##.##.....##.##.....##..##..##..##.......##....##....##....##.....##......##..##.....##..##..##.....##
//.##........##..........##.......##.....##.##.......##.....##.##........##..##...........##...##.....##..##..##.....##.....##...##.....##.##.....##.##.....##...####...##.......##..........##....##.....##.....##...##.....##..##..##.....##
//.##...####.######......##.......########..######...########..######....##..##..........##....##.....##..##..##.....##....##....########..########..##.....##....##....######...##..........##....##.....##....##....########...##..##.....##
//.##....##..##..........##.......##........##.......##...##...##........##..##.........##.....##.....##..##..##.....##...##.....##........##...##...##.....##....##....##.......##..........##....##.....##...##.....##.........##..##.....##
//.##....##..##..........##.......##........##.......##....##..##........##..##........##......##.....##..##..##.....##..##......##........##....##..##.....##....##....##.......##....##....##....##.....##..##......##.........##..##.....##
//..######...########....##.......##........########.##.....##.##.......####.########.##........#######..####.########..##.......##........##.....##..#######.....##....########..######.....##.....#######..##.......##........####.########.
//*/
router.get("/perfil/:id/proyecto/:project_id", async (req, res) => {
  const { id, project_id } = req.params;

  console.log(id);
  console.log(project_id);
  const project = await db.query(
    "SELECT * FROM projects WHERE project_id = ?",
    [project_id]
  );

 /* const likedb = await db.query("SELECT * FROM likes WHERE project_id = ?", [
    project_id,
  ]);*/

  const user = await db.query("SELECT * FROM users WHERE id = ?", [id]);

  if (user.length > 0) {
    if (project.length > 0) {
      res.render("profile/project.html", {
        proyecto: project[0],
        usuario: user[0],
      });
    } else {
      res.redirect("/perfil/" + id);
    }
  } else {
    res.redirect("/");
  }
});

module.exports = router;
